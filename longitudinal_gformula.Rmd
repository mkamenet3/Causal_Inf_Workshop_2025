---
title: "Longitudinal G-Formula"
author: "A. Keil and M.Kamenetsky"
date: "2025-02"
output:
  html_document:
    code_folding: hide
---

## Research Questions:

<!-- - To estimate the effects of radon on all cause mortality in a dataset of uranaium mine workers -->
- To estimate the effects of air pollutants from a coal-fired power plant on ....*TODO*

## Learning Objectives:

By the end of this tutorial, you will be able to:

- Complete a parametric g-formula analysis using `R` software



## Key Points:

- TODO
- TODO


## Outline





```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
answerkey <- TRUE
```

First, we load in the libraries needed for this analysis. If you have not installed these libraries yet, please be sure to do so using `install.packages("packagename")`.


```{r, class.source = 'fold-show'}
#Load in libraries
library(ggplot2) #for plotting
library(dplyr) #for data cleaning
library(survival) #for survival analysis
#library(tibble)
library(boot) #for bootstrapping
library(ggcorrplot)
```


Our dataset is a (simulated) birth cohort of 3,961 individuals, followed up to 2 years of age in a U.S. city. The outcome of interest is the Mental Development Index (MDI) measured at age 2. The exposures of interest are 3 metals known to be emitted from coal-fired power plants: arsenic, beryllium, and cadmium. These eposures are measured as annual ambient levels from birth to age 1 via passive monitoring. The confounder of interest is urbanicity.

Our directed acyclic graph (DAG) of the research question is:

**TODO USE DAGGITY TO DRAW DAG HERE**


Next, we load in the data set `coalplant` and perform an initial exploratory data analysis:

```{r, class.source = 'fold-show'}
coalplant <- read.csv("2018_ISEE_causal-master/analyses/data/coalplant.csv")
str(coalplant)
```


By using the `str()` command, we identify the following 4 variables:

**MORE INFO ON THE DATASET**

- `id`: a unique identifier for each individual *TODO: check this, what are the units, where did this data come from?*
- `as`: arsenic levels
- `be`: beryllium levels
- `cd`: cadmium levels
- `mdi`: Mental Development Index (MDI) measured at age 2
- `urbanicity`: 0/1 indicator taking 1 if participant lived in an urban area or 0 otherwise

We first look at the summary statistics for the continuous variables and a table for the binary variable, `urbanicity`.

```{r, class.source = 'fold-show'}
summary(coalplant[, 2:5])
table(coalplant$urbanicity)

```

We observe similar distributions for the three exposures. The mean and median MDI scores are both around 97. Most participants live in an urban setting `r table(coalplant$urbanicity)[[2]]`.

To visualize the data, we create histograms and facet by urbanicity status:

```{r, class.source = 'fold-show'}
ggplot(data=coalplant) +
  geom_histogram(aes(x=as)) +
  theme_bw() +
  ggtitle("Histogram of Arsenic") +
  facet_grid(.~ urbanicity)

ggplot(data=coalplant) +
  geom_histogram(aes(x=be)) +
  theme_bw() +
  ggtitle("Histogram of Beryllium") +
  facet_grid(.~ urbanicity)

ggplot(data=coalplant) +
  geom_histogram(aes(x=cd)) +
  theme_bw() +
  ggtitle("Histogram of Cadmium") +
  facet_grid(.~ urbanicity)


ggplot(data=coalplant) +
  geom_histogram(aes(x=mdi)) +
  theme_bw() +
  ggtitle("Histogram of MDI") +
  facet_grid(.~ urbanicity)

```




We observe large differences in distributions for the exposures by urbanicity. Intuitively, this makes sense based on background knowledge - living in a more urban area you exposure to co-pollutants will be different from those living in more rural or suburban areas. We examine summary statistics once more by urbanicity status:


```{r, class.source = 'fold-show'}
coalplant %>%
  filter(urbanicity==1) %>%
  summary()

coalplant %>%
  filter(urbanicity==0) %>%
  summary()


```

```{r, class.source = 'fold-show'}
exposures <- c("as", "be","cd")
corr <- cor(coalplant[, exposures])
ggcorrplot(corr)

```


We also observe high-correlations amongst the three exposures.

We will use a linear model using the `lm()` function in `R`. We include interactions between urbanicity and each of the three exposure pollutants, as well as interactions between the exposures as well


```{r, class.source = 'fold-show'}
mdimod = lm(mdi ~ as*urbanicity + be*urbanicity + cd*urbanicity + as*be + as*cd + be*cd, data=coalplant)
summary(mdimod)
plot(mdimod)
```

Under the "natural course" (coal-fire power plant continues to operate), we can estimate the average joint effect of the three exposures on a given individual by taking the mean of the predictions:

```{r, class.source = 'fold-show'}

mean(predict(mdimod))
```

More formally, we are expecting no reduction in any of the exposures. More explicitly, we can write the code as:

```{r, class.source = 'fold-show'}
#create new data set for prediction
dat_nc <- coalplant %>%
    mutate(as = as*(1-0.00), #no reduction in as
         be = be*(1-0.00), #no reduction in be
         cd = cd*(1-0.00)) #no reduction in cd
  
#predict mean MDI 
(nc <- mean(predict(mdimod, newdata = dat_nc)))
  
```


**TODO: INTERPRETATION**




In other words, the expected MDI score for a given individual being exposed to the coal-fire power plant is `r mean(predict(mdimod))`.


Suppose that based on prior research, we know that 91% of arsenic, 96% of beryllium, and 45% of cadmium ambient levels come from a local coal-fired power plant. One **joint effect** of interest would be what would happen if we reduced the exposures by the proportion expected by decommissioning the power plant? 

```{r, eval=answerkey, echo=answerkey}
#create new data set based on new intervention
dat_no_coal <- coalplant %>%
  mutate(as = as*(1-0.96),
         be = be*(1-0.91),
         cd = cd*(1-0.45))
#predict mean MDI 
(no_coal <- mean(predict(mdimod, newdata = dat_no_coal)))
  
  
```


What would be the joint effect from only setting arsenic levels to 0?

```{r, eval=answerkey, echo=answerkey}
dat_no_as <- coalplant %>%
  mutate(as = as*0)
#predict mean MDI 
(no_as <- mean(predict(mdimod, newdata = dat_no_as)))
```


What would be the joint effect from only setting beryllium levels to 0?

```{r, eval=answerkey, echo=answerkey}
dat_no_be <- coalplant %>%
  mutate(be = be*0)
#predict mean MDI 
(no_be <- mean(predict(mdimod, newdata = dat_no_be)))
```


What would be the joint effect from only setting cadmium levels to 0?

```{r, eval=answerkey, echo=answerkey}
dat_no_cd <- coalplant %>%
  mutate(cd = cd*0)
#predict mean MDI 
(no_cd <- mean(predict(mdimod, newdata = dat_no_cd)))
```

```{r, eval=answerkey, echo=answerkey, results='asis', class.source = 'fold-show'}
c(naturalcourse = nc, 
  no_coal = no_coal, 
  no_arsenic = no_as, 
  no_beryllium = no_be, 
  no_cadmium = no_cd) %>%
  knitr::kable(col.names = c("Model","Predicted Mean MDI"))

```
<!-- How would we estimate mean MDI under each intervention? -->

**SUMMARIZE HERE, INTERPRETATION TODO**



In order to obtain valid confidence intervals, we must bootstrap using the `boot` package.






